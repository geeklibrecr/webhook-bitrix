openapi: 3.0.0
info:
  title: Webhook Bitrix API
  version: 1.0.0
  description: API para recibir webhooks desde Bitrix24
paths:
  /webhook:
    post:
      summary: Recibe eventos desde Bitrix24
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                event:
                  type: string
                data:
                  type: object
                  description: Objeto libre con la informaciÃ³n enviada por Bitrix24.
                  properties:
                    FIELDS:
                      type: object
                      description: ColecciÃ³n abierta de campos Bitrix24; se rellenan con `null` si no llegan.
                      properties:
                        ID:
                          type: string
                          description: ID del negocio.
                        TITLE:
                          type: string
                          description: TÃ­tulo del negocio.
                        TYPE_ID:
                          type: string
                          description: Tipo de negocio (SALE, SERVICE, etc.).
                        
                        OPPORTUNITY:
                          type: number
                          format: double
                          description: Monto del trato.
                        CURRENCY_ID:
                          type: string
                          description: Moneda (USD, CRC, etc.).
                        DATE_CREATE:
                          type: string
                          format: date-time
                          description: Fecha de creaciÃ³n.
                        ASSIGNED_BY_FULL_NAME:
                          type: string
                          description: Nombre completo del responsable.
                        ASSIGNED_BY_EMAIL:
                          type: string
                          format: email
                          description: Email del responsable.
                        CONTACT_ID:
                          type: string
                        
                        CONTACT_FULL_NAME:
                          type: string
                        CONTACT_EMAIL:
                          type: string
                          format: email
                        CONTACT_PHONE:
                          type: string
                        COMPANY_ID:
                          type: string
                        COMPANY_TITLE:
                          type: string
                        COMPANY_PHONE:
                          type: string
                        COMPANY_EMAIL:
                          type: string
                          format: email
                        DESTINATARIO:
                          type: string
                        TELEFONO:
                          type: string
                        PROVINCIA:
                          type: string
                        CANTON:
                          type: string
                        DISTRITO:
                          type: string
                        CODIGO_POSTAL:
                          type: string
                        DETALLE_DIRECCION:
                          type: string
                        NUMERO_REFERENCIA:
                          type: string
                        DETALLE_REFERENCIA:
                          type: string
                      additionalProperties: true
                  additionalProperties: true
            example:
              event: ONCRMDEALUPDATE
              data:
                FIELDS:
                  ID: "123"
                  TITLE: "Negocio de prueba"
                  TYPE_ID: "SALE"
                  OPPORTUNITY: 1500.5
                  CURRENCY_ID: "USD"
                  DATE_CREATE: "2024-05-01T10:15:00Z"
                  ASSIGNED_BY_FULL_NAME: "Ana Perez"
                  ASSIGNED_BY_EMAIL: "ana@example.com"
                  CONTACT_ID: "45"
                  CONTACT_FULL_NAME: "Luis Andres Gomez"
                  CONTACT_EMAIL: "luis@example.com"
                  CONTACT_PHONE: "+50688887777"
                  COMPANY_ID: "77"
                  COMPANY_TITLE: "Empresa Demo"
                  COMPANY_PHONE: "+50640001111"
                  COMPANY_EMAIL: "contacto@empresa.demo"
                  DESTINATARIO: "Juan Perez"
                  TELEFONO: "+50660001111"
                  PROVINCIA: "San Jose"
                  CANTON: "Montes de Oca"
                  DISTRITO: "San Pedro"
                  CODIGO_POSTAL: "11501"
                  DETALLE_DIRECCION: "De la iglesia 100m norte, casa azul"
                  NUMERO_REFERENCIA: "REF-ABC-123"
                  DETALLE_REFERENCIA: "Tocar el porton negro"
      responses:
        '200':
          description: OK
  /printqueue:
    get:
      summary: Lista items de la cola de impresiÃ³n
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [pendiente, procesando, impreso, error]
          required: false
          description: Filtra por estado de la cola
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  count:
                    type: integer
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                          description: ID del Ã­tem en cola
                        fields:
                          type: object
                          description: Objeto con los FIELDS recibidos
                          additionalProperties: true
                        status:
                          type: string
                          enum: [pendiente, procesando, impreso, error]
                        webhookEvent:
                          type: string
                          description: ID del WebhookEvent relacionado
                        createdAt:
                          type: string
                          format: date-time
  /printqueue/{id}/status:
    patch:
      summary: Actualiza el estado de un item de la cola
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID del item en cola
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [pendiente, procesando, impreso, error]
              required: [status]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  item:
                    type: object
                    description: Item actualizado
        '400':
          description: Solicitud invÃ¡lida
        '404':
          description: Item no encontrado
  /printqueue/imprimir/{id}:
    post:
      summary: Genera una etiqueta/imprime y marca el item como impreso
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID del item en cola
      responses:
        '200':
          description: HTML imprimible de etiqueta
          content:
            text/html:
              schema:
                type: string
        '404':
          description: Item no encontrado
                        updatedAt:
                          type: string
                          format: date-time
