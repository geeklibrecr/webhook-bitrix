openapi: 3.0.0
info:
  title: Webhook Bitrix API
  version: 1.0.0
  description: API para recibir webhooks desde Bitrix24
paths:
  /webhook:
    post:
      summary: Recibe eventos desde Bitrix24
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                event:
                  type: string
                data:
                  type: object
                  description: Objeto libre con la información enviada por Bitrix24.
                  properties:
                    FIELDS:
                      type: object
                      description: Colección abierta de campos Bitrix24; se rellenan con `null` si no llegan.
                      properties:
                        ID:
                          type: string
                          description: ID del negocio.
                        TITLE:
                          type: string
                          description: Título del negocio.
                        TYPE_ID:
                          type: string
                          description: Tipo de negocio (SALE, SERVICE, etc.).
                        
                        OPPORTUNITY:
                          type: number
                          format: double
                          description: Monto del trato.
                        CURRENCY_ID:
                          type: string
                          description: Moneda (USD, CRC, etc.).
                        DATE_CREATE:
                          type: string
                          format: date-time
                          description: Fecha de creación.
                        ASSIGNED_BY_FULL_NAME:
                          type: string
                          description: Nombre completo del responsable.
                        ASSIGNED_BY_EMAIL:
                          type: string
                          format: email
                          description: Email del responsable.
                        CONTACT_ID:
                          type: string
                        
                        CONTACT_FULL_NAME:
                          type: string
                        CONTACT_EMAIL:
                          type: string
                          format: email
                        CONTACT_PHONE:
                          type: string
                        COMPANY_ID:
                          type: string
                        COMPANY_TITLE:
                          type: string
                        COMPANY_PHONE:
                          type: string
                        COMPANY_EMAIL:
                          type: string
                          format: email
                        DESTINATARIO:
                          type: string
                        TELEFONO:
                          type: string
                        PROVINCIA:
                          type: string
                        CANTON:
                          type: string
                        DISTRITO:
                          type: string
                        CODIGO_POSTAL:
                          type: string
                        DETALLE_DIRECCION:
                          type: string
                        NUMERO_REFERENCIA:
                          type: string
                        DETALLE_REFERENCIA:
                          type: string
                      additionalProperties: true
                  additionalProperties: true
            example:
              event: ONCRMDEALUPDATE
              data:
                FIELDS:
                  ID: "123"
                  TITLE: "Negocio de prueba"
                  TYPE_ID: "SALE"
                  OPPORTUNITY: 1500.5
                  CURRENCY_ID: "USD"
                  DATE_CREATE: "2024-05-01T10:15:00Z"
                  ASSIGNED_BY_FULL_NAME: "Ana Perez"
                  ASSIGNED_BY_EMAIL: "ana@example.com"
                  CONTACT_ID: "45"
                  CONTACT_FULL_NAME: "Luis Andres Gomez"
                  CONTACT_EMAIL: "luis@example.com"
                  CONTACT_PHONE: "+50688887777"
                  COMPANY_ID: "77"
                  COMPANY_TITLE: "Empresa Demo"
                  COMPANY_PHONE: "+50640001111"
                  COMPANY_EMAIL: "contacto@empresa.demo"
                  DESTINATARIO: "Juan Perez"
                  TELEFONO: "+50660001111"
                  PROVINCIA: "San Jose"
                  CANTON: "Montes de Oca"
                  DISTRITO: "San Pedro"
                  CODIGO_POSTAL: "11501"
                  DETALLE_DIRECCION: "De la iglesia 100m norte, casa azul"
                  NUMERO_REFERENCIA: "REF-ABC-123"
                  DETALLE_REFERENCIA: "Tocar el porton negro"
      responses:
        '200':
          description: OK
  /printqueue:
    get:
      summary: Lista items de la cola de impresión
      parameters:
        - in: query
          name: status
          schema:
            type: string
            enum: [pendiente, procesando, impreso, error]
          required: false
          description: Filtra por estado de la cola
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  count:
                    type: integer
                  items:
                    type: array
                    items:
                      type: object
                      properties:
                        _id:
                          type: string
                          description: ID del ítem en cola
                        fields:
                          type: object
                          description: Objeto con los FIELDS recibidos
                          additionalProperties: true
                        status:
                          type: string
                          enum: [pendiente, procesando, impreso, error]
                        webhookEvent:
                          type: string
                          description: ID del WebhookEvent relacionado
                        createdAt:
                          type: string
                          format: date-time
  /printqueue/{id}/status:
    patch:
      summary: Actualiza el estado de un item de la cola
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID del item en cola
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status:
                  type: string
                  enum: [pendiente, procesando, impreso, error]
              required: [status]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  item:
                    type: object
                    description: Item actualizado
        '400':
          description: Solicitud inválida
        '404':
          description: Item no encontrado
  /printqueue/imprimir/{id}:
    post:
      summary: Genera una etiqueta/imprime y marca el item como impreso
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
          description: ID del item en cola
      responses:
        '200':
          description: HTML imprimible de etiqueta
          content:
            text/html:
              schema:
                type: string
        '404':
          description: Item no encontrado
                        updatedAt:
                          type: string
                          format: date-time
  /clients:
    get:
      description: 'Lee directamente desde MongoDB Atlas (DB: webhookbitrix, colecci?n: lars_clients) y devuelve todos los documentos tal cual se almacenan.'
      description: 'Lee directamente desde MongoDB Atlas (DB: bitrix_handler, colecci?n: lars_clients) y devuelve todos los documentos tal cual se almacenan.'
      parameters:
        - in: query
          name: bitrixId
          schema:
            type: integer
          required: false
          description: Filtra por el identificador numerico del registro en Bitrix.
        - in: query
          name: entityType
          schema:
            type: string
          required: false
          description: Filtra por el tipo de entidad (`company`, `contact`, etc.).
        - in: query
          name: page
          schema:
            type: integer
            minimum: 1
          required: false
          description: Numero de pagina a devolver (1 por defecto).
        - in: query
          name: pageSize
          schema:
            type: integer
            minimum: 1
            maximum: 500
          required: false
          description: Tamano de pagina (50 por defecto, maximo 500). El parametro `limit` se acepta como alias para compatibilidad.
      responses:
        '200':
          description: Lista de clientes obtenida correctamente
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  count:
                    type: integer
                    example: 2
                  pagination:
                    type: object
                    properties:
                      page:
                        type: integer
                        example: 1
                      pageSize:
                        type: integer
                        example: 50
                      total:
                        type: integer
                        example: 120
                      totalPages:
                        type: integer
                        example: 3
                      hasMore:
                        type: boolean
                        example: true
                  clients:
                    type: array
                    description: Documentos completos tal como se guardan en la colecci?n.
                    items:
                      type: object
                      additionalProperties: true
              example:
                status: ok
                count: 1
                pagination:
                  page: 1
                  pageSize: 50
                  total: 21
                  totalPages: 1
                  hasMore: false
                clients:
                  - _id:
                      $oid: 69154f735fa533aab499ec1b
                    bitrixId: 42
                    entityType: company
                    payload:
                      ID: "42"
                      TITLE: Denarios TECH
                      COMPANY_TYPE: SUPPLIER
                      INDUSTRY: IT
                      COMMENTS: ""
                      REVENUE: "100000000"
                      CURRENCY_ID: CRC
                      ASSIGNED_BY_ID: "20"
                      DATE_CREATE: "2025-11-11T20:01:29+03:00"
                      LAST_ACTIVITY_TIME: "2025-11-11T20:01:29+03:00"
                      PHONE:
                        - ID: "194"
                          VALUE_TYPE: WORK
                          VALUE: "+50622612182"
                          TYPE_ID: PHONE
                      EMAIL:
                        - ID: "196"
                          VALUE_TYPE: WORK
                          VALUE: denarios.info@gmail.com
                          TYPE_ID: EMAIL
                    syncedAt:
                      $date: "2025-11-13T03:28:26.575Z"
